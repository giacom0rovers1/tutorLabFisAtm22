---
title: "Precipitation processing with tidyverse - R Notebook"
output: html_notebook
---

**Autore**: Giacomo Roversi

Laboratorio di Fisica dell'Atmosfera A.A. 2022/23

# Esperienza 3

------------------------------------------------------------------------


## Inizializzazione


Per cominciare inizializziamo l'ambiente di calcolo: cancello eventuali variabili e carico i pacchetti necessari.

```{r}
# Clear the workspace
rm(list=ls())
```

```{r}
# Load packages

packages <- c(
  "tidyverse",
  "lubridate",
  "zoo",
  "terra"
)

for(pkg in packages){
  
  if(!require(pkg, character.only = T)){
    install.packages(pkg)
  } 
  
  library(pkg, character.only = T)
}

tidyverse_logo()
```

```{r}
# Define the working directory (in this case, the path is different depending on whether the code is executed on Linux or Windows, but just for my convenience)

if(Sys.info()["sysname"]=="Linux"){
  setwd("/home/giacom0rovers1/tutorLabFisAtm22/Esp_3/")
}else{
  setwd("C:/projects/tutorLabFisAtm22/Esp_3/")
}
```


### Definizione dei nomi dei files e delle cartelle

In questo caso `datafolder` è la cartella dentro cui si trovano le sottocartelle dei dati grezzi (ATTENZIONE: sono vari GB!), `resfolder` conterrà tutti i dati processati e i risultati, `figfolder` le figure.

```{r}
# Define the project directories (relative path)
datafolder <- "~/Insync/giacomo.roversi2@studio.unibo.it/OneDrive Biz - Shared/Laboratorio di Fisica dell'Atmosfera/Studenti_Esp3/"

HSAF.folder <- paste0(datafolder, "SAT/")
RG.folder   <- paste0(datafolder, "PLV/")
GPM.folder   <- paste0(datafolder, "GPM/")
ERA5.folder   <- paste0(datafolder, "ERA/")

figfolder  <- "figure/"
# resfolder  <- "risultati/"

# Create the project directories, if missing
if(!dir.exists(figfolder)){  dir.create(figfolder) }
# if(!dir.exists(resfolder)){  dir.create(resfolder) }

```


```{r}
# https://hub.arcgis.com/datasets/2b93b06dc0dc4e809d3c8db5cb96ba69_0/

GlobalBG <- vect(paste0(datafolder,"World_Countries_(Generalized)"))
ItalyBG  <- GlobalBG[112]

plot(ItalyBG, col="grey")


```

Fornisce sia i confini da plottare, sia un dominio con cui mascherare i raster (`mask` esegue il ritaglio che segue i bordi, mentre `crop` prende la bounding box)



## Griglia comune ("MyGrid"):

Creo un oggetto SpatRaster sull'Italia

```{r}
MyGrid <- rast(ncol=250, nrow=150, 
               xmin=0, xmax=25, 
               ymin=35, ymax=50)

MyGrid

```

Situazione e obiettivo

Input: 4 risoluzioni spaziali e temporali diverse
Output: stessa griglia, cumulate orarie (o mm/h medi orari)


## Import data


```{r}
CorrectionFactor_HSAF = 3600 # 1
CorrectionFactor_ERA5 = 1000 # 1
```



### A) ERA5 

```{r}
ERA5.files <- dir(ERA5.folder, pattern=".grib")
length(ERA5.files)
```


```{r}
## Import data ------------------------------------------------------------------
ERA5.raster <- rast(paste0(ERA5.folder, ERA5.files)) * CorrectionFactor_ERA5
dim(ERA5.raster)
```


```{r}
## Assign Date ------------------------------------------------------------------
ERA5.times_START <- substr(ERA5.files,6,15)
ERA5.times_END   <- substr(ERA5.files,17,26)

ERA5.times <- format(seq(ymd_h(ERA5.times_START), ymd_h(ERA5.times_END), by="1 hour"), "%Y%m%d%H%M")

names(ERA5.raster) <- ERA5.times

ERA5.raster
```


```{r}
plot(ERA5.raster[["201610012100"]])
plot(ItalyBG, add =T)
```


```{r}
ERA5.MyGrid <- terra::project(ERA5.raster, MyGrid)


plot(ERA5.MyGrid[["201610012100"]])
plot(ItalyBG, add =T)

```


```{r}
plot(
  clamp(ERA5.MyGrid[["201610012100"]], 0.2, values=F), 
  main = ymd_hm(names(ERA5.MyGrid[["201610012100"]])),
  col=c("blue","green","yellow","orange","red"),  
  xlab   = "Longitude (°E)",
  ylab   = "Latitude (°N)",
  panel.first = {
    plot(crop(GlobalBG, MyGrid), col="gray90", add=T)
    grid()
  }
)
```









### B) H-SAF
- importare i dati HSAF e rasterizzarli


```{r}
# Search GRIB files ------------------------------------------------------------
HSAF.files <- dir(HSAF.folder, pattern=".grb")
HSAF.files <- HSAF.files[substr(HSAF.files,9,12)=="1001"]  # scelgo solo 1 giorno... non molto elegante
length(HSAF.files)
```



```{r message=FALSE, warning=FALSE}
## Import data (Precipitation Rate [kg/m2 s]) ------------------------------------
HSAF.list <- list()
for(i in 1:length(HSAF.files)) {
  HSAF.list[[i]] <- rgdal::readGDAL(paste0(HSAF.folder,HSAF.files[i]), silent = TRUE)
}

length(HSAF.list)
dim(HSAF.list[[1]])
```


```{r}
## Import Coordinates (unstructured grid) ---------------------------------------
HSAF.coordinates <- read.table(file(paste0(datafolder,"SAT_coordinates.dat")),
                               sep = " ", na.string = NA, as.is = TRUE, header = FALSE)
dim(HSAF.coordinates)

## Assign Date ------------------------------------------------------------------
HSAF.times <- paste0(substr(HSAF.files,5,12),substr(HSAF.files,14,17))
HSAF.times [c(1,length(HSAF.times))]
```


```{r message=FALSE, warning=FALSE}
## Merge Data -------------------------------------------------------------------
HSAF.df <- HSAF.coordinates[1710000:1,]
for(i in 1:length(HSAF.times)) HSAF.df <- cbind(HSAF.df, matrix(HSAF.list[[i]][[1]], dim(HSAF.list[[1]])[1], 1))
colnames(HSAF.df) <- c("Lon", "Lat", HSAF.times)

head(HSAF.df)
dim(HSAF.df)
```

```{r}

HSAF.df_ITA <- HSAF.df %>% filter(
  Lon >= 0,
  Lon <= 30,
  Lat >= 30,
  Lat <= 60
) 

rownames(HSAF.df_ITA) <- 1:nrow(HSAF.df_ITA)

head(HSAF.df_ITA)
```


```{r}
HSAF.raster <- rasterize(cbind(HSAF.df_ITA$Lon, HSAF.df_ITA$Lat), MyGrid, values=as.array(HSAF.df_ITA[["201610012057"]])) * CorrectionFactor_HSAF

HSAF.raster <- clamp(HSAF.raster, 0, values=F)

names(HSAF.raster) <- "201610012057"
HSAF.raster

plot(HSAF.raster)
plot(GlobalBG, add=T)

plot(ItalyBG, col="grey")
plot(HSAF.raster[["201610012057"]], 
     add=T, 
     col=c("blue","green","yellow","orange","red"))

```



```{r}
# !! I nomi degli assi rimangono fuori dal plot! Probelma del notebook probabilmente

# png(filename = paste0(figfolder, "test.png"),
#     width    = 480,
#     height   = 322,
#     units    = "px")

plot(
  HSAF.raster[["201610012057"]], 
  main = names(HSAF.raster[["201610012057"]]),
  col=c("blue","green","yellow","orange","red"),  
  xlab   = "Longitude (°E)",
  ylab   = "Latitude (°N)",
  panel.first = {
    plot(crop(GlobalBG, MyGrid), col="gray90", add=T)
    # plot(ItalyBG, col="gray80", add=T)
    grid()
  }
)

# dev.off()

```


- filtri
??




- analisi


```{r}
hist(HSAF.raster, "201610012057")

```





### C) GPM-IMERG


```{r}
# Search IMR files (ASCII) -----------------------------------------------------
GPM.files <- dir(GPM.folder, pattern=".imr")
GPM.files <- GPM.files[substr(GPM.files,5,8)=="1001"]
length(GPM.files)

## Import data (Precipitation Rate [mm/h]) --------------------------------------
GPM.list <- list()
for(i in 1:(length(GPM.files)) ) {
  GPM.list[[i]] <- read.table(file(paste0(GPM.folder,GPM.files[i])), skip = 181, nrows = 180,
                              sep = ",", na.string = NA, as.is = TRUE, header = FALSE)
  GPM.list[[i]]  <- as.matrix(GPM.list[[i]][-1])
}

length(GPM.list)
dim(GPM.list[[1]])

## Import Coordinates (structured grid) -----------------------------------------
LatGPM <- read.table(file(paste0(GPM.folder,GPM.files[1])), skip = 361, nrows = 1,
                     sep = ",", na.string = NA, as.is = TRUE, header = FALSE)
temp   <- LatGPM[[2]]
for(i in 3:length(LatGPM)) temp[i-1] <- LatGPM[[i]]
LatGPM <- temp

LonGPM <- read.table(file(paste0(GPM.folder,GPM.files[1])), skip = 362, nrows = 1,
                     sep = ",", na.string = NA, as.is = TRUE, header = FALSE)
temp   <- LonGPM[[2]]
for(i in 3:length(LonGPM)) temp[i-1] <- LonGPM[[i]]
LonGPM <- temp

c(length(LonGPM),length(LatGPM))


GPM.coordinates <- 0
for(i in LonGPM) for(j in LatGPM) GPM.coordinates <- c(GPM.coordinates,i,j)
```


```{r}
# Data extraction
GPM.coordinates2 <- t(matrix(GPM.coordinates[-1], 2, length(LonGPM)*length(LatGPM)))

## Assign Date ------------------------------------------------------------------
GPM.times <- paste0(substr(GPM.files,1,8),substr(GPM.files,11,14))
GPM.times [c(1,length(GPM.times))]

names(GPM.list) <- GPM.times
```

```{r}
GPM.raster <- rasterize(GPM.coordinates2, MyGrid, values=as.array(t(GPM.list[["201610012100"]])))

GPM.raster <- clamp(GPM.raster, 0, values=F)

names(GPM.raster) <- "201610012100" #GPM.times[idGPM]
GPM.raster
```


```{r}
plot(GPM.raster)
plot(ItalyBG, add =T) #, col = "grey85")
# ItalyBGfun(NULL, "red")

```


```{r}
plot(
  clamp(GPM.raster, 0.2, values=F), 
  main = names(GPM.raster),
  col=c("blue","green","yellow","orange","red"),  
  xlab   = "Longitude (°E)",
  ylab   = "Latitude (°N)",
  panel.first = {
    plot(crop(GlobalBG, MyGrid), col="gray90", add=T)
    grid()
  }
)
```





### D) RAIN GAUGES



```{r}
# Search DAT files -------------------------------------------------------------
RG.files <- dir(RG.folder, pattern=".dat")
RG.files <- RG.files[substr(RG.files,5,8)=="1001"]
length(RG.files)

## Assign Date ------------------------------------------------------------------
RG.times <- substr(RG.files,1,12)
RG.times[c(1,length(RG.times)-1)]

## Import Pixel Coordinates (unstructured grid) ---------------------------------
RG.coordinates <- read.table(file(paste0(datafolder, "PLV_coordinates.dat")),
                             sep = "", na.string = NA, as.is = TRUE, header = FALSE,
                             col.names = c("x","y","lat","lon"))

# trasformazioni necessarie ma ignote (non sappiamo l'origine dei dati)
# probabilmente sono stati salvati con una diversa convenzione di lettura di matrice
RG.coordinates$x <- rev(RG.coordinates$x)
RG.coordinates <- RG.coordinates %>% arrange(x, y)

## Import data (Precipitation Rate [mm/h]) --------------------------------------
nROW <- 444
nCOL <- 912
RG.df <- data.frame(matrix(ncol = 0, nrow = nROW*nCOL))
for(i in 1:(length(RG.files)) ) {
  tt <- RG.times[i]
  RG.df <- cbind(RG.df, readBin(paste0(RG.folder,RG.files[i]), "numeric", nROW*nCOL, size=4))  }

colnames(RG.df) <- RG.times

latlon <- tibble(id = 1:nrow(RG.coordinates), RG.coordinates[c("lon", "lat")])

latlon <- latlon %>% filter(
  lat >= 35,
  lat <= 50,
  lon >= 0,
  lon <= 25
)

RG.raster <- rasterize(cbind(latlon$lon, latlon$lat), MyGrid, values=RG.df[latlon$id,22])

RG.raster <- clamp(RG.raster, 0, values=F)

names(RG.raster) <- RG.times[22]
RG.raster

plot(RG.raster)
plot(ItalyBG, add =T) #, col = "grey85")
# ItalyBGfun(NULL, "red")

```






## Dominio spaziale omogeneo (Italia in questo caso)
mask (per avere base spaziale comune)

```{r}
plot(mask(ERA5.MyGrid[["201610012100"]], ItalyBG))


```



```{r}

ERA5.final <- mask(ERA5.MyGrid[["201610012100"]], ItalyBG)
RG.final <- mask(RG.raster, ItalyBG)

par(mfrow=c(1,2))
plot(ERA5.final)
plot(RG.final)

```




## Aggregazione: medie orarie

(manca)





## PDFs

```{r}
ERA5.data <- values(ERA5.final)
hist(ERA5.data)

RG.data <- values(RG.final)
hist(RG.data)
```


```{r}
tibble(
  Raingauges = RG.data,
  ERA5 = ERA5.data
) %>% 
  pivot_longer(
    cols = c("Raingauges", "ERA5"),
    names_to = "Product",
    values_to = "Precipitation"
  )%>%
  ggplot(aes(Precipitation, color = Product)) + 
  geom_freqpoly() + 
  scale_y_log10()

```



## Indicatori statistici


```{r}

statsFun_continuous <- function(Var, Ref){
  
  # continuous
  CC   <- signif(cor(data$Var, data$Ref, method = "pearson", use = "na.or.complete"), 2)
  mean <- signif(mean(data$Ref, na.rm = T),2)
  me   <- signif(mean(data$Var - data$Ref, na.rm = T), 2)
  ME   <- signif(mean(data$Var - data$Ref, na.rm = T)/mean, 2)
  mae  <- signif(mean(abs(data$Var - data$Ref), na.rm = T), 2)
  MAE  <- signif(mean(abs(data$Var - data$Ref), na.rm = T)/mean, 2)
  rmse <- signif(sqrt(mean((data$Var - data$Ref)^2, na.rm = T)), 2)
  CV   <- signif(rmse/mean, 2)
  SMP  <- nrow(na.omit(data))
  R2   <- signif(CC^2, 2)
  
  
  avgR  = mean(Ref)
  SMP   = length(na.omit(Var))
  COR   = cor(Var, Ref, use = "pairwise.complete.obs")
  ME    = mean(Var - Ref, na.rm = T)
  MAE   = mean(abs(Var - Ref), na.rm = T)
  RMSE  = sqrt(mean((Var - Ref)^2, na.rm = T))
  MAX   = max(Var, na.rm = T)
  nME   = ME/avgR
  nMAE  = MAE/avgR
  CV    = RMSE/avgR
  
  table <- data.frame(SMP, avgR, nME, nMAE, CV, COR, ME, MAE, RMSE, MAX)
  
  return(signif(table, 3))
}

statsFun_categorical <- function(Var, Ref){
  xtab <- xtabs(~ Ref + Var, data = cat, na.action = "na.omit")
  
  
  hits <- xtab['TRUE' ,'TRUE' ]  #[2,2]#
  crej <- xtab['FALSE','FALSE']  #[1,1]#
  miss <- xtab['TRUE' ,'FALSE']  #[2,1]#
  fala <- xtab['FALSE','TRUE' ]  #[1,2]#
  
  FAR  <- fala/(hits + fala)
  BIAS <- (hits + fala)/(hits + miss)
  POD  <-  hits/(hits + miss)       
  TS   <-  hits/(hits + miss + fala)  
  SMP  <- sum(xtab)
  
  ACC  <-  (hits + crej)/(hits + fala + miss + crej)
  POFD <- fala/(fala + crej) 
  
  rand <- (hits+miss)*(hits+fala)/SMP
  ETS  <- (hits - rand)/(hits + miss + fala - rand)
  
  table <- data.frame(SMP, FAR, BIAS, POD, TS, ACC, POFD, ETS)
  
  return(signif(table, 3))
}


```


## Scatterplots

```{r}
tibble(RG.data,
       ERA5.data) %>%
  ggplot(aes(RG.data, ERA5.data)) +
  geom_bin_2d(binwidth = 0.2) + 
  coord_fixed() + 
  theme_bw()
# aggiungere scala colore log

```

